function initReplies(t,e){replies[t]=e}function checkSession(){comments.checkSession(function(t){if(null==t)$("body").removeClass("has-session");else{if(t.Email&&$("#user-email").append(t.Email),$('[data-type="user-name"]').text(t.Name),t.UsingFacebook&&""!=t.FacebookAvatar){var e=$("<img/>");e.src=t.FacebookAvatar,$(String.format('[data-type="user-avatar"][data-userid="{0}"]',t.Id)).html(e)}$("body").addClass("has-session")}})}function logout(){comments.logout(function(){$("body").removeClass("has-session")})}function generateBoxComment(e){var t=$("#tplBoxComment").html(),o=$(t);o.attr("data-parentid",e);var n=o.find('[data-type="comment-content"]');return n.val(comments.getLastComment(e)),n.keyup(function(t){comments.setLastComment(e,$(this).val())}),o}function showProfile(t){$(t).popupWindow({windowURL:appSettings.ajaxDomain+"/User/Profile.aspx",width:680,height:840,centerScreen:1,windowName:"profile"})}function login(t){$(t).popupWindow({windowURL:"/home/login",width:500,height:380,centerScreen:1,windowName:"popupform"})}function register(t){$(t).popupWindow({windowURL:"/home/register",width:500,height:380,centerScreen:1,windowName:"popupform"})}function showHelp(t){$(t).popupWindow({windowURL:"/comment-doc.html",width:780,height:680,centerScreen:1,windowName:"popupform",scrollbars:1})}function share(t,e){$(t).popupWindow({windowURL:"https://www.facebook.com/sharer/sharer.php?u=<%=RequestExtensionProperties.ObjectUrl%>?commentId="+e,width:500,height:380,centerScreen:1,windowName:"popupform",scrollbars:1})}function sendComment(e,t,o){comments.sendComment(e,t,function(t){switch(parseInt(t)){case comments.statusCode.hasMultiCommentCookie:alert("Thời gian chờ tối thiểu giữa mỗi lần bình luận là 10 giây.");break;case comments.statusCode.noSession:openLoginForm();break;case comments.statusCode.error:alert("Có lỗi xảy ra, bạn vui lòng thử lại sau ít phút nữa."),closeReplyComment(e);break;case comments.statusCode.success:alert("Bình luận của bạn đã được gửi đi và đang chờ duyệt. Xin cảm ơn."),o(),closeReplyComment(e),comments.removeLastComment(e)}})}function sendComment2(e,t,o,n){comments.sendComment2(e,t,o,function(t){(t=t||{}).Success&&0==t.ErrorCode?(alert("Bình luận của bạn đã được gửi đi và đang chờ duyệt. Xin cảm ơn."),n(),closeReplyComment(e),comments.removeLastComment(e)):(alert("Có lỗi xảy ra, bạn vui lòng thử lại sau ít phút nữa."),closeReplyComment(e))})}function closeReplyComment(t){$(String.format('[data-type="comment-item"][data-id="{0}"] [data-type="comment-reply-placeholder"]',t)).stop(!0,!0).hide()}function openLoginForm(){$('[data-type="button-login"]:first').click()}function openRegisterForm(){$('[data-type="button-register"]:first').click()}function buildLikedCookieName(t){return String.format("data-comment-liked[{0}]",t)}function reloadCommentInfo(t){var e=String.format('[data-type="comment-item"][data-id="{0}"]',t),o=$(e),n=buildLikedCookieName(t),a=parseFloat(o.attr("data-liked")),i=o.find(String.format('[data-type="comment-nav"][data-id="{0}"]',t));"true"==vcCore.getCookie(n)?(i.find('[data-type="button-like"]').text("Bỏ thích"),0==a&&(a=1)):i.find('[data-type="button-like"]').text("Thích"),0<a?(i.find('[[data-type="liked"]').text(a),i.find('[data-group="liked"]').show()):i.find('[data-group="liked"]').hide()}function loginFacebook(t){postMessage2({action:"loginFacebook",params:{message:t}})}function loginGoogle(t){postMessage2({action:"loginGoogle",params:{message:t}})}function initEventsForListComment(){$('[data-type="comment-item"][data-isprocessed="0"]').each(function(){var n=$(this),t=1==n.attr("data-isparent"),a=t?n.attr("data-id"):n.attr("data-parentid"),i=n.attr("data-id"),r=n.find('[data-type="list-comment"]');n.find('[data-type="button-loadcomment"]').unbind("click").bind("click",function(){var t=$(this),e=replies[a];if(t.removeAttr("data-type"),t.toggleClass("toggle"),t.unbind("click").bind("click",function(){r.find('[data-type="comment-item"]').toggle(),t.toggleClass("toggle")}),e&&0!=e.length){var o=r.attr("data-template"),n=$("<div/>");n.setTemplate($("#"+o).html(),null,{runnable_functions:!0,filter_data:!1}).processTemplate(e),r.prepend(n.html()),initEventsForListComment()}else t.fadeOut(function(){t.remove()})}).click(),n.find('[data-type="button-like"]').unbind("click").bind("click",function(){var e=$(this),o=buildLikedCookieName(i);return"true"==vcCore.getCookie(o)?(n.attr("data-liked",Math.max(0,parseFloat(n.attr("data-liked"))-1)),vcCore.setCookie(o,null,(new Date).addDays(365)),void reloadCommentInfo(i)):void("1"!=e.attr("data-isloading")&&(e.attr("data-isloading","1").addClass("loading"),ajax.comment.like(i,{success:function(t){e.removeAttr("data-isloading").removeClass("loading"),n.attr("data-liked",parseFloat(n.attr("data-liked"))+1),vcCore.setCookie(o,"true",(new Date).addDays(365)),reloadCommentInfo(i)}})))}),reloadCommentInfo(i);var e=t?n.find('[data-type="comment-reply-placeholder"]'):n.closest('[data-isparent="1"]').find('[data-type="comment-reply-placeholder"]');void 0!==e&&n.find('[data-type="button-reply"]').unbind("click").bind("click",function(){"0"==e.attr("data-generated")&&(e.append(generateBoxComment(a)),e.attr("data-generated",1),checkSession()),$('[data-type="comment-reply-placeholder"]').hide(),e.show().find('[data-type="comment-content"]').focus(),postMessage2({action:"scrollTop",params:{top:e.offset().top}})}),n.attr("data-isprocessed",1)})}function initEventsForListCommentStream(){var c=$('[data-type="list-commentstream"]');$('[data-type="button-loadcommentstream"]').unbind("click").bind("click",function(){var i=$(this);if("1"!=i.attr("data-isloading")){i.attr("data-isloading","1").addClass("loading");var r=parseInt(i.attr("data-start")),s=parseInt(i.attr("data-rows"));comments.getComments(0,r,s,function(t){if(i.attr("data-start",r+s).attr("data-isloading","0").removeClass("loading"),!t||0==t.length)return 0==r&&$(".list-comments").remove(),void i.fadeOut(function(){i.remove()});t.length<s&&i.fadeOut(function(){i.remove()});var e=c.attr("data-template"),o=$("<div/>");if(o.setTemplate($("#"+e).html(),null,{runnable_functions:!0,filter_data:!1}).processTemplate(t),i.before(o.html()),initEventsForListComment(),0==r){var n=vcCore.getUrlParameter("commentId",window.location.href);if(""!=n){var a=$("#comment-"+n);postMessage2(a&&0<a.length?{action:"scrollTop",params:{top:a.offset().top}}:{action:"scrollTop",params:{top:0}})}}})}}).click()}function getFirstCharacterOfName(t){if(""==t)return"";var e=(t=$.trim(t)).split(" ");return e[e.length-1][0]}function reformatDate(t){var e=new Date(t),o=e.getFullYear()==(new Date).getFullYear()?"":e.getFullYear();return String.format("{0}:{1} ngày {2}/{3}{4}",e.getHours()<10?"0"+e.getHours():e.getHours(),e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes(),e.getDate()<10?"0"+e.getDate():e.getDate(),e.getMonth()<9?"0"+(e.getMonth()+1):e.getMonth()+1,""==o?"":String.format("/{0}",o))}function postMessage2(t){try{top.postMessage(t,"*")}catch(t){console.log&&console.log(t.message)}}var replies=[],comments=function(){function a(t){return String.format("[{0}][{1}][{2}]-LastComment",i.objectType,i.objectId,t)}var i={objectId:"",objectType:0,objectTitle:"",objectUrl:"",zoneId:0},r={hasMultiCommentCookie:-2,noSession:-1,error:0,success:1},s=[],o=null;return{setLastComment:function(t,e){var o,n;o=e,n=a(t),vcCore.setCookie(n,o,(new Date).addMinutes(5))},getLastComment:function(t){return e=a(t),vcCore.getCookie(e);var e},removeLastComment:function(t){var e;e=a(t),vcCore.setCookie(e,"",(new Date).addMinutes(5)),vcCore.deleteCookie(e)},init:function(t){i=$.extend(i,t),setInterval(function(){postMessage2({action:"resetHeight",params:{height:$("body").height()}})},1e3)},sendComment:function(t,e,o){$.ajax({url:jsSettings.ApiComments+"/api/comment/addcomment",xhrFields:{withCredentials:!0},data:{objectType:i.objectType,objectId:i.objectId,objectTitle:i.objectTitle,objectUrl:i.objectUrl,zoneId:i.zoneId,parentId:t,content:e,keyExpire:vcCore.getCookie("cdlgifdaec")},type:"post",error:function(){"function"==typeof o&&o(r.error)},success:function(t){"function"==typeof o&&o(t)}})},sendComment2:function(t,e,o,n){$.ajax({url:jsSettings.ApiComments+"/api/comment/addcommentv2",xhrFields:{withCredentials:!0},data:{objectType:i.objectType,objectId:i.objectId,objectTitle:i.objectTitle,objectUrl:i.objectUrl,zoneId:i.zoneId,parentId:t,content:e,keyExpire:vcCore.getCookie("cdlgifdaec"),author:o},type:"post",error:function(){"function"==typeof n&&n(r.error)},success:function(t){"function"==typeof n&&n(t)}})},getComments:function(t,e,o,n){0<i.objectType&&0<i.objectId&&$.ajax({url:String.format(jsSettings.ApiComments+"/api/comment/list/{0}-{1}-{2}-{3}-{4}.htm",i.objectType,i.objectId,t,e,o),dataType:"json",contentType:"application/json",success:function(t){"function"==typeof n&&n(t)}})},getAvatarColor:function(t){if(void 0!==s[t]&&null!=s[t])return s[t];var e=getRandomInt(0,150),o=getRandomInt(0,150),n=getRandomInt(0,150);return s[t]="rgb("+e+","+o+","+n+")",s[t]},statusCode:r,checkSession:function(e){null!=o&&"function"==typeof e&&e(o),$.ajax({url:jsSettings.ApiComments+"/api/usercomment/currentuser",data:{KeyExpire:vcCore.getCookie("cdlgifdaec")},type:"get",dataType:"json",success:function(t){null!=t?(null!=t&&(o=t),"function"==typeof e&&e(JSON.parse(t))):vcCore.setCookiePath("cdlgifdaec",null,-1)}})},logout:function(t){vcCore.setCookiePath("cdlgifdaec",null,-1),o=null,"function"==typeof t&&t()}}}(jQuery),listenToParent=function(t){if("<%=ParentDomain%>"==t.origin&&t.data&&t.data.action)switch(t.data.action){case"recomment":return setTimeout(function(){$(String.format('[data-type="comment-form"][data-parentid="{0}"] [data-type="button-send"]',t.data.params.parentId)).click()},1e3),void checkSession();case"checkSession":return void checkSession()}};